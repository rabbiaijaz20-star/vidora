{% extends 'base.html' %}

{% block content %}

<div class="watch-page">

    <!-- MAIN AREA -->
    <div class="video-section">

        <!-- VIDEO PLAYER -->
        <div class="video-container">
            <video controls>
                <source src="{{ video.video_file.url }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        </div>

        <!-- TITLE -->
        <h1 class="video-title">{{ video.title }}</h1>

        <!-- STATS + LIKE BUTTONS -->
        <div class="video-actions">
            <div class="video-meta">
                <span>{{ video.views_count }} views</span>
                <span>‚Ä¢</span>
                <span>{{ video.uploaded_at|timesince }} ago</span>
            </div>

            <div class="like-area">
                {% if user.is_authenticated %}
                    <button
                      id="like-btn"
                      class="like-btn"
                      data-video-id="{{ video.id }}">
                      üëç   {% if user_liked %}Liked{% else %}Like{% endif %}
                      ({{ video.video_likes.count }})
                    </button>

                {% else %}
                    <a href="{% url 'login' %}" class="login-hint">Login to like</a>
                {% endif %}
            </div>
        </div>

        <!-- CHANNEL INFO -->
        <div class="channel-box">
            <div class="channel-left">
                <div class="avatar-circle">
                    {{ video.uploader.username|slice:":1" }}
                </div>
                <div>
                    <h4 class="channel-name">{{ video.uploader.username }}</h4>
                </div>
            </div>
        </div>

        <!-- DESCRIPTION -->
        <div class="description-box">
            <p>{{ video.description }}</p>
        </div>

        <!-- COMMENTS SECTION -->
        <h3 class="comment-header">Comments ({{ video.get_comments_count }})</h3>

        {% if user.is_authenticated %}
            <form method="POST" action="{% url 'comments:add_comment' video.id %}" class="comment-form">
                {% csrf_token %}
                <textarea name="text" rows="3" class="comment-input" placeholder="Add a comment..."></textarea>
                <button type="submit" class="comment-submit">Comment</button>
            </form>
        {% else %}
            <a href="{% url 'login' %}" class="login-hint">Login to comment</a>
        {% endif %}

        <!-- DISPLAY COMMENTS -->
        <div class="comments-section">
            {% for comment in comments %}
                <div class="comment-box">
                    <strong>{{ comment.user.username }}</strong>
                    <p>{{ comment.text }}</p>

                    {% for reply in comment.get_replies %}
                        <div class="reply-box">
                            <strong>{{ reply.user.username }}</strong>
                            <p>{{ reply.text }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>

    </div>

    <!-- SIDEBAR RELATED VIDEOS -->
    <div class="sidebar">
        <h3 class="sidebar-title">Related Videos</h3>

        {% for rv in related_videos %}
            <a href="{% url 'videos:watch' rv.id %}" class="related-video-card">
                <img src="{{ rv.thumbnail.url }}" class="related-thumb">

                <div class="related-info">
                    <h4 class="related-title">{{ rv.title }}</h4>
                    <p class="related-meta">{{ rv.uploader.username }} ‚Ä¢ {{ rv.views_count }} views</p>
                </div>
            </a>
        {% endfor %}
    </div>

</div>


<style>

    .watch-page {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 25px;
        margin: 30px auto;
        max-width: 1250px;
        padding: 20px;
    }

    .video-container video {
        width: 100%;
        border-radius: 12px;
        background: #000;
    }

    .video-title {
        font-size: 22px;
        font-weight: 700;
        margin-top: 15px;
        margin-bottom: 10px;
        color: #111;
    }

    .video-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .video-meta {
        color: #606060;
        font-size: 14px;
        display: flex;
        gap: 6px;
    }

    .like-btn {
        background: #f2f2f2;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        transition: 0.2s;
    }

    .like-btn:hover {
        background: #e0e0e0;
    }

    .channel-box {
        display: flex;
        align-items: center;
        margin-top: 15px;
    }

    .channel-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .avatar-circle {
        background: #d1d1d1;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 700;
        font-size: 20px;
        color: white;
    }

    .channel-name {
        margin: 0;
        font-size: 16px;
        font-weight: 700;
    }

    .description-box {
        background: #f8f8f8;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        font-size: 14px;
        line-height: 1.5;
    }

    .comment-header {
        margin-top: 25px;
        font-size: 18px;
        font-weight: 600;
    }

    .comment-form {
        margin-top: 15px;
    }

    .comment-input {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-bottom: 10px;
        font-size: 14px;
    }

    .comment-submit {
        background: #065fd4;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
    }

    .comment-box {
        background: #fff;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #eee;
        margin-top: 12px;
    }

    .reply-box {
        margin-left: 20px;
        padding-left: 10px;
        border-left: 2px solid #ccc;
        margin-top: 8px;
    }

    /* SIDEBAR RELATED */
    .sidebar-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 15px;
    }

    .related-video-card {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        text-decoration: none;
        color: inherit;
    }

    .related-thumb {
        width: 160px;
        height: 90px;
        border-radius: 8px;
        object-fit: cover;
        background: #000;
    }

    .related-title {
        font-size: 14px;
        font-weight: 600;
        margin: 0;
        line-height: 1.3;
    }

    .related-meta {
        font-size: 12px;
        color: #606060;
    }

</style>
<script>
const likeBtn = document.getElementById("like-btn");

if (likeBtn) {
    likeBtn.addEventListener("click", function () {
        fetch("{% url 'likes:toggle_like' video.id %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                likeBtn.innerText = data.liked
                    ? `üëç Liked (${data.likes_count})`
                    : `üëç Like (${data.likes_count})`;
            }
        });
    });
}
</script>


{% endblock %}
